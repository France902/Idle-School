<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Idle School</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap');

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            background-color: rgb(186, 240, 254);
            touch-action: none;
            user-select: none;
            pointer-events: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
        }

        h1 {
            position: fixed;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 1.2vw;
            text-align: center;

        }
       
        img {
            image-rendering: crisp-edges; 
            transform: translateZ(0); 
        }

        #world {
            transform: scale(0.07);
            transform-origin: center center;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            margin-left: -3vw;
            margin-top: 5vh;
            will-change: transform;
            transition: margin-top 1.5s ease-out, margin-left 1.5s ease-out;
            top: 0;
            left: 0;
        }

        #table_costruction{
            position: fixed;
            width: 20vw;
            height: 15vh;
            z-index: 0;
            transition: left 0.3s ease-in-out, top 0.3s ease-in-out;
            object-fit: cover;
        }

        #costruction_menu{
            position: fixed;
            width: 70vw;
            height: 85vh;
            object-fit: cover;
            justify-content: center;
            align-items: center;
            display: flex;
            top: 0vh;
            left: 15vw;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        #platform_1 {
            width: 10vw;
            height: 12vh;
            position: fixed;
            background-color: rgb(168, 108, 3);
            transition: left 0.3s ease-in-out, top 0.3s ease-in-out;
            z-index: -1;
        }

        #platform_2 {
            width: 23.44vw;        
            height: 33.33vh;      
            position: fixed;
            background-color: rgb(124, 3, 168);
            margin-top: 28.5vh;    
            margin-left: 39.65vw;  
            display: none; 
            z-index: -1;
        }

        #preside_container {
            position: fixed;
            top: 50%;
            left: 30%;
            transform: translate(-110%, -120%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 10vw;
            height: 10vw;
            border-radius: 1vw;
        }

        #platform_container {
            position: fixed;
            transform: translate(-510%, 250%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 10vw;
            height: 10vw;
            border-radius: 1vw;
            opacity: 0;
        }

        #bob_container{
            position: fixed;
            left: 70vw;
            top: 39vh;
        }
        #bob_character{
            transform: scaleX(-1);
            width: 28vw;
            height: 27vh;
        }

        #tertiary_container{
            position: fixed;
            left: 80vw;
            top: 39vh;
        }
        #tertiary_character{
            width: 28vw;
            height: 20vh;
        }

        #preside {
            width: 30vw;
            height: 30vh;
            position: fixed;
            top: 0vh;
            left: 0vw;
            transition: left 0.1s, top 0.1s;
        }

        #student {
            width: 3.3vw;          
            height: 5vh;       
            background-color: red;
            position: fixed;
            top: 39vh;   
            left: 72.7vw;
            transition: left 0.3s ease-in-out, top 0.3s ease-in-out;
        }

        #missions {
            position: fixed; 
            left: 80vw; 
            top: 14vh; 
            width: 17vw;
        }
        #img_preside_dialogues {
            position: fixed;
            z-index: -1;
            height: 120vh;
            top: -30vh;
            margin-left: -45vw;
            object-fit: cover;
            pointer-events: none;
            transform: scale(0.8); 
            transform-origin: center center;
            transition: transform 0.3s ease-in-out;
        }
        #anonymous_character_dialogues {
            position: fixed;
            z-index: -1;
            width: 30vw;
            height: 80vh;
            top: 5vh;
            margin-left: 60vw;
            object-fit: cover;
            pointer-events: none; 
            transform: scale(0.9); 
            transform-origin: center center;
            transition: transform 0.3s ease-in-out;
        }

        #dialogues_container {
            position: fixed;
            top: 0;
            left: 0vw;
            width: 100vw;
            height: 97vh;
            display: flex;
            justify-content: center;
            align-items: end;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #dialogues {
            background-color: rgba(255, 255, 255);
            border-radius: 1.5vw;
            padding-left: 2vw;
            padding-right: 2vw;
            margin: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 80vw;
            height: 33vh;
            font-size: 2.2vw;
            color: black;
            text-align: left;
            font-family: "Comic Neue", cursive;
            font-weight: 400;
            position: fixed;
            z-index: 0;
        }

        #dialogues_text {
            margin: 0;
            padding: 0;
            white-space: pre-wrap; 
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            margin-top: 7.5vh;
            margin-left: 1.5vw;
        }

        #character_name {
            margin: 0;
            padding: 0;
            white-space: pre-wrap; 
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            margin-top: 1.8vh;
        }

        #name_box{
            background-color: rgba(255, 255, 255);
            border-radius: 5vw;
            padding-left: 0.5vw;
            padding-right: 0.5vw;
            margin: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            width: 14vw;
            height: 10vh;
            top: 54vh;
            font-size: 2vw;
            margin-left: 5vw;
            color: black;
            text-align: center;
            font-family: "Comic Neue", cursive;
            font-weight: 800;
            position: fixed;
            z-index: 1;
        }

        #bob_illustration, #tertiary_illustration {
            position: fixed;
            width: 10vw;
            height: 15vh;
            top: 32vh;
            left: 82.8vw;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.1s ease-in-out, left 0.25s ease-in-out, top 0.25s ease-in-out;
        }
        #cinematic-bars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        

        .bar {
            position: absolute;
            height: 7vh;
            width: 100%;
            background-color: black;
            transition: transform 0.5s ease;
            z-index: 9999;
        }

        .top {
            top: 0;
            transform: translateY(-100%);
        }

        .bottom {
            bottom: 0;
            transform: translateY(100%);
        }

        .cinematic .top {
            transform: translateY(0);
        }

        .cinematic .bottom {
            transform: translateY(0);
        }

        .hud-container {
            position: fixed;
            top: 1.5vh;
            right: 1vw;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1vh;
            z-index: 5;
        }

        .hud-box {
            background-color: rgba(0, 0, 0, 0.6); 
            color: white;
            font-family: Arial, sans-serif;
            font-size: 1.2vw;
            padding: 0.6vh 1vw;
            border: 0.15vw solid white;
            border-radius: 0.6vw;
            min-width: 8vw;
            text-align: right;
            position: fixed;
        }

        .hud_missions {
            position: absolute;
            top: 14.5vh;
            right: 5vw;
            width: 17vw;
            background-color: rgba(50, 50, 50, 0.6);
            opacity: 1;
            border: 0.15vw solid white;
            border-radius: 0.6vw;
            padding: 0.6vh 0 0.6vh 1vw; 
            color: white;
            box-shadow: 0 0.4vw 0.8vw rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            pointer-events: auto;
        }

        .toggle-icon {
            position: absolute;
            top: 0.6vh;
            right: 0.4vw;
            width: 2vw;
            height: 3vh;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }

        .mission_1, .mission_2, .mission_3 {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 3.3vh 0;
            cursor: pointer;
        }

        .mission_1 h1, .mission_2 h1, .mission_3 h1 {
            font-size: 1.7vw;
            margin: 0;
            padding-left: 4vw;
            word-break: break-word;
            white-space: normal;
        }

        .mission_1 img, .mission_2 img, .mission_3 img {
            width: 3vw;
            height: 5vh;
        }

        .mission_2, .mission_3 {
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            
        }

        .hud_missions.open .mission_1, .hud_missions.open .mission_2, .hud_missions.open .mission_3 {
            opacity: 1;
            cursor: auto;
        }

        .hud_missions.closed .mission_1 {
            cursor: pointer;
        }

        .hud_missions.closed {
            max-height: 10vh;
            cursor: pointer;
        }

        .hud_missions.open {
            max-height: 30vh;
            cursor: auto;
        }
        .school_imgs {
            position: fixed;
            z-index: 0;
            transform: scale(1);
            transition: left 0.35s ease-in-out, top 0.35s ease-in-out;
            will-change: transform, left, top;
        }
        .sprite {
            backface-visibility: hidden;
        }


        @keyframes fadeOpacity {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    
    <div id="loader-container" >
         <div id="loader-bar"></div>
    </div>
  <div id="world">
    <div id="canvas" class="school_imgs" style="top: -550vh; left: -200vw;" class="sprite">

    <img src="giardino_bordo_alto1.png" style="width: 210vw; height: 240vh; display: block; position: fixed;">
    <img src="giardino_alto1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; left: 210vw;">
    <img src="giardino_alto2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; left: 420vw;">
    <img src="giardino_bordo_alto2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; left: 630vw;">

    <img src="giardino_bordo_mezzo1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 240vh;">
    <img src="giardino_mezzo1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 240vh; left: 210vw;">
    <img src="giardino_mezzo2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 240vh; left: 420vw;">
    <img src="giardino_bordo_mezzo2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 240vh; left: 630vw;">

    <img src="giardino_bordo_basso1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 480vh;">
    <img src="giardino_basso1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 480vh; left: 210vw;">
    <img src="giardino_basso2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 480vh; left: 420vw;">
    <img src="giardino_bordo_basso2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 480vh; left: 630vw;">

    <img src="strada_bordo1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 720vh;">
    <img src="strada_mezzo1.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 720vh; left: 210vw;">
    <img src="strada_mezzo2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 720vh; left: 420vw;">
    <img src="strada_bordo2.png" style="width: 210vw; height: 240vh; display: block; position: fixed; top: 720vh; left: 630vw;">


    </div>
        

    <div id="platform_container">
            <img class="school_imgs" src="a_rock.jpg" style="position: fixed; left: 50vw; top: -30vh; width: 15vw; height: 25vh; z-index: 0;">
    </div>
    <div id="table_costruction" class="school_imgs" style="background-color: aqua; left: 165vw; top: -10vh;">
        
    </div>
    
    <div id="preside_container">
        <img src="Preside.png" id="preside">
    </div>
    </div>
    <div id="dialogues_container">
        <div id="name_box">
            <p id="character_name">name personaggio</p>
        </div>
        <div id="dialogues">
            <p id="dialogues_text">Prova-dialogo</p>
        </div>
        <img src="Preside.png" alt="" id="img_preside_dialogues">

        <img src="personaggio_anonimo.png" alt="" id="anonymous_character_dialogues">
        
    </div>

    <div id="cinematic-bars" class="cinematic">
        <div class="bar top"></div>
        <div class="bar bottom"></div>
    </div>

    

    
    <div class="hud-container" id="hud" style="display: none;">
        <img src="icona_zoom.png" onclick=" scale(true)" style="width: 3vw; height: 3vw; transform: translate(-95vw); cursor: pointer; pointer-events: auto;">
        <br>
        <img src="icona_casa.png" onclick="scale('predefinito')" style="width: 3vw; height: 3vw; transform: translate(-95.2vw); cursor: pointer; pointer-events: auto;" >
        <br>
        <img src="icona_dezoom.png" onclick="scale(false)" style="width: 3vw; height: 3vw; transform: translate(-95vw); cursor: pointer; pointer-events: auto;" >
        <div id="costruction_menu" style="background-color: white;"></div>
        <!--
        <div id="money" class="hud-box">0 🪙</div>
        <div id="classes" class="hud-box" style="top: 8vh;">0 🏫</div>
        <div id="missions" class="hud_missions closed" >
        <img class="toggle-icon" src="icona_menu_missions.png" alt="Icona Toggle" onclick="menu_missions()">
        <div class="mission_1" onclick="toggleMenu()">
            <img src="icona_punto_interrogativo.png" alt="Icona Missione 1">
            <h1>missione 1</h1>
        </div>
        <div class="mission_2" onclick="toggleMenu()">
            <img src="icona_punto_interrogativo.png" alt="Icona Missione 2">
            <h1>missione 2</h1>
        </div>
        <div class="mission_3" onclick="toggleMenu()">
            <img src="icona_punto_interrogativo.png" alt="Icona Missione 3">
            <h1>missione 3</h1>
        </div>
        -->
    </div>
    <!--

    <div id="cartello-orizzontale" class="school_imgs" style="position: fixed; width: 20vw; height: 7.87vh; left: 93vw; top: -10.33vh; z-index: 2; display: flex; align-items: center; justify-content: center; font-family: Arial, sans-serif; font-size: 1vw; color: #333; transition: left 0.3s ease-in-out, top 0.3s ease-in-out;">
        <p id="text_cartello" style="font-size: 1.8vw; font-family: 'Gloria Hallelujah', cursive; white-space: nowrap; overflow: visible;">A new school is opening!</p>
    </div>


    <div id="platform_2">
        <div class="banco" id="banco1" style="margin-top: 4.17vh; margin-left: 14.58vw;"><p>Banco1</p></div>
        <div class="banco" id="banco2" style="margin-top: 20.83vh; margin-left: 14.58vw;"><p>Banco2</p></div>
        <div id="cattedra" style="margin-top: 12.5vh; margin-left: 1.56vw;"><p>Cattedra</p></div>
    </div>

    <div id="blocco_pulizia_1" class="blocco_pulizia" style="margin-left: 58.23vw; margin-top: 31vh; display: none;"></div>

    <div id="blocco_pulizia_2" class="blocco_pulizia" style="margin-left: 58.23vw; margin-top: 47vh; display: none;"></div>
-->
        
    </div>
    
<script>
window.onload = startGame;


function startGame() {
  const elements = initialiseElements();
  const state = initialiseStates();
  createInteractableKeys(elements, state);
  setupDialogue(elements, state);
  controlSkip(elements, state);
  waitForImagesToLoad(document.getElementById("world"), () => {
    setTimeout(() => scaleWorld(elements), 1000);
  });
  gameScripts(elements, state);
  creationTertiaryCharacters(elements, state);
  mobileAdaptation(elements, state);
  // setupMenuToggle(elements);
}

function gameScripts(e, state) {
    centralizationPreside(e, state);
    diaologueB_P1(e, state);
}

function initialiseElements() {
  return {
    // Core del gioco
    canvas: document.getElementById('progressCircle'),
    world: document.getElementById('world'),
    moneyText: document.getElementById('money'),
    menu: document.getElementById('missions'),
    hud: document.getElementById('hud'),
    costruction_menu: document.getElementById('costruction_menu'),
    
    // Giocatore e interazioni
    student: document.querySelector('.student'),
    toggle_icon: document.querySelector('.toggle-icon'),
    platform_1: document.getElementById('platform_1'),
    platform_2: document.getElementById('platform_2'),
    keyE: document.getElementById('key_e'),
    
    // Dialoghi e narrativa
    dialogues: document.getElementById('dialogues'),
    text_dialogue: document.getElementById('dialogues_text'),
    container_dialogue: document.getElementById('dialogues_container'),
    imgPreside: document.getElementById('img_preside_dialogues'),
    anonymousCharacter: document.getElementById('anonymous_character_dialogues'),
    characterName: document.getElementById('character_name'),
    boxname: document.getElementById('name_box'),
    preside: document.getElementById('preside'),
    preside_container: document.getElementById('preside_container'),
    
    // Decorazioni
    scuolaImgs: document.querySelectorAll('.school_imgs'),
    imgsArray: Array.from(document.querySelectorAll('.school_imgs')),

    // Notifiche / sbloccabili
    unlockedText: document.getElementById('unlocked')
  };
}


function initialiseStates() {
  return {
    // state principale
    money: 0,
    classes: 0,

    // Interazioni e click
    cond_movement: false,
    cond_jumpB: true,
    cond_jumpT: false,
    cond_skip: true,
    cond_dialogue: false,
    cond_text: true,
    condBP1: false,

    // Posizioni
    posX: 0,
    posY: 0,
    pos_student: 0,
    posBX: 70,
    posBY: 39,
    ids: [],

    // Condizioni ambientali
    cond_platform_1: false,
    cond_deactivate_movement: false,

    // state generico
    maxTimeAnimationGroup: [N],
    maxTimeAnimationWorkAlone: [N],
    maxTimeAnimationAlone: [N],
  };
}

const matTert = [
        [ '175vw', '-15vh', "group", 1, false, 'personaggio_anonimo.png'],
        [ '163vw', '-3vh', "group", 2, false, 'personaggio_anonimo.png' ],
        [ '163vw', '-27vh', "group", -2, false, 'personaggio_anonimo.png'],
        [ '13vw', '-27vh', "work-alone", 1, false, 'personaggio_anonimo.png'],
        [ '90vw', '110vh', "alone", -1, false, 'personaggio_anonimo.png'],
        [ '70vw', '33vh', "group", 1, false, 'bob.png'],
        [ '80vw', '39vh', "group", 1, false, 'personaggio_anonimo.png'],
        ['180vw', '100vh', "group", -1, false, 'personaggio_anonimo.png'],
        ['190vw', '100vh', "group", 1, false, 'personaggio_anonimo.png'],
        [ '103vw', '50vh', "walk-casually", -1, false, 'personaggio_anonimo.png'],
    ];
    
const importantObjects = [
    [ '158vw', '-3vh', '158vw', '-27vh', 'tavolo']
];


let zoom = 0.9;
function scale(condition, elements = initialiseElements(), state = initialiseStates()) {
    elements.world.style.transition = "transform 0.3s ease-in-out, margin-top 1.5s ease-out, margin-left 1.5s ease-out";
    if(condition === 'predefinito') {
        zoom = 0.9;
        elements.world.style.transform = `scale(${zoom})`;
        return;
    }
    if (condition) {
        if (zoom <= 1.32) {
            zoom += 0.07;
            elements.world.style.transform = `scale(${zoom})`;
        }
    }
    else{
        if (zoom >= 0.63) {
            zoom -= 0.07;
            elements.world.style.transform = `scale(${zoom})`;
        }
    }
}

function waitForImagesToLoad(container, callback) {
  const images = container.querySelectorAll('img');
  let loaded = 0;

  if (images.length === 0) {
    callback();
    return;
  }

  images.forEach(img => {
    if (img.complete) {
      loaded++;
      if (loaded === images.length) callback();
    } else {
      img.onload = img.onerror = () => {
        loaded++;
        if (loaded === images.length) callback();
      };
    }
  });
}

function scaleWorld(e) {
  let scale = 0.07;
  const target = 0.9;
  const speed = 0.006;

  
  if (e.world.dataset.scaling === "true") return;
  e.world.dataset.scaling = "true";

  function animate() {
    scale += speed;
    if (scale >= target) {
      scale = target;
      e.world.style.transform = `scale(${target})`;
      e.world.dataset.scaling = "false"; 
      return; 
    }

    e.world.style.transform = `scale(${scale})`;
    requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}


function createInteractableKeys(e, state) {
    const pos_keys = [
        ['90vw', '105vh'],
        ['152vw', '-25vh'],
    ]
    for(let i=0;i<pos_keys.length;i++){
        if(pos_keys[i][0] != false){
            const key = document.createElement('img');
            key.src = 'tasto_e.png';
            key.id = 'key_e' + i;
            key.className = 'school_imgs';
            key.style.width = '5vw';
            key.style.height = '5vw';
            key.style.opacity = '0';
            key.style.left = parseFloat(pos_keys[i][0]) + 8 + 'vw';
            key.style.top = parseFloat(pos_keys[i][1]) - 7 + 'vh';
            e.world.appendChild(key);
        }
    }
}

function setupDialogue(e, state) {
  const lines = [
    ["Ciao! Sono Bob, della Building & Co!", "Bob", 2, 0, true],
    ["Questo posto è proprio enorme!", "Bob", 2, 0, false],
    ["Spero che ne sia valsa la pena comprarlo...", "preside", 1, 0, false],
    ["Puoi stare tranquillo! quando sei con noi potrai contare sulle migliori braccia della città!", "Bob", 2, 0, false],
    ["Siamo quasi pronti, quando vuoi iniziare vieni al tavolo di costruzione!", "Bob", 2, true, false, -100, 35],
    [true],
  ];
  let index = 0;

  function showText(text, velocity = 15) {
    e.text_dialogue.textContent = "";
    let i = 0;
    state.cond_skip = true;
    let write = function () {
      if (!state.cond_text) {
        e.text_dialogue.textContent = text;
        state.cond_text = true;
        state.cond_skip = false;
        return;
      }
      if (i < text.length) {
        e.text_dialogue.textContent += text[i++];
        setTimeout(write, velocity);
      } else {
        state.cond_skip = false;
      }
    };
    write();
  }

  function changeName(name) {
    e.characterName.textContent = name;
  }

  function changeBoxName(pos) {
    const left = pos === 1;
    e.boxname.style.left = left ? "11vw" : "65vw";
    e.imgPreside.style.transform = left ? "scale(0.9)" : "scale(0.8)";
    e.anonymousCharacter.style.transform = left ? "scaleX(-1) scale(0.9)" : "scaleX(-1) scale(1)";
    e.imgPreside.style.opacity = left ? "1" : "0.8";
    e.anonymousCharacter.style.opacity = left ? "0.8" : "1";
  }

  function showNextLine() {
    if(lines[index][0] == true){
        state.cond_text = false;
        state.cond_skip = false;
        e.container_dialogue.style.opacity = 0;
        state.cond_movement = true;
        state.cond_dialogue = false;
        resetMoveWorld(e, -3, 5)
        activateHud(e);
        setUpPresideMovement(e, state);
        return;
    }
    if (index < lines.length) {
        if(lines[index][3] == true){
        state.cond_dialogue = false;
        moveWorld(e, lines[index][5], lines[index][6]);
        setTimeout(() => {
            state.cond_dialogue = true;
        }, 2000);
      } 
      if(lines[index][4] == true) deactivateCinematicMode(e);
      showText(lines[index][0]);
      changeName(lines[index][1]);
      changeBoxName(lines[index][2]);
      changeCharacters(lines[index][1]);

      index++;
    }
  }

  showText("Prova dialogo animato");
  changeName("name preside");
  changeBoxName(1);

  window.showNextLine = showNextLine;

  function changeCharacters(name){
        if(name != 'preside'){
            e.anonymousCharacter.src = name + ".png"; 
            e.anonymousCharacter.style.transition = '';
            e.anonymousCharacter.style.transform = 'scaleX(-1)';
        }
    }
}

function controlSkip(elements, state) {
  window.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      if (state.cond_skip && state.cond_dialogue) state.cond_text = false;
      else if (state.cond_dialogue) window.showNextLine();
    }
  });

  window.addEventListener('mousedown', e => {
    if (e.button === 0) {
      if (state.cond_skip && state.cond_dialogue) state.cond_text = false;
      else if (state.cond_dialogue) window.showNextLine();
    }
  });
}

function activateHud(e){
    e.hud.style.display = '';
}

function moveWorld(e, distanceX, distanceY){
    e.world.style.marginLeft = '-3vw';
    e.world.style.marginTop = '5vh';
    e.world.style.marginLeft = parseFloat(e.world.style.marginLeft) + distanceX + "vw";
    e.world.style.marginTop = parseFloat(e.world.style.marginTop) + distanceY + "vh";
}

function resetMoveWorld(e, distanceX, distanceY){
    e.world.style.transition = '';
    e.world.style.marginLeft = distanceX + "vw";
    e.world.style.marginTop = distanceY + "vh";

setTimeout(() => {
    e.world.style.transition = "transform 0.3s ease-in-out, margin-top 1.5s ease-out, margin-left 1.5s ease-out";
}, 1600);
}

let intervalMovement;

function setUpPresideMovement(e, state) {
  const p = e.preside;
  p.style.top = '0vh';
  p.style.left = '0vw';
    let isCharging = false;
    let jumpStartTime = 0;
    let currentDir = { x: 0, y: 0 };
    let keys = {};

    if(state.cond_movement){
        window.addEventListener('keydown', handleKeydown);
        window.addEventListener('keyup', handleKeyup);

        intervalMovement = setInterval(() => {
            if (isCharging) return;
            currentDir = getDirection();
            if (currentDir.x !== 0 || currentDir.y !== 0) {
                isCharging = true;
                jumpStartTime = performance.now();
            }
        }, 16);
    } else {
        window.removeEventListener('keyup', handleKeyup);
        window.removeEventListener('keydown', handleKeydown);
        clearInterval(intervalMovement);
    }

function pointClickMovement(){

    let clickTimer;
    document.addEventListener('mousedown', (event) => {
    clickTimer = setTimeout(() => {
        ClickMovement(event);
    }, 1000); 
    });

    document.addEventListener('mouseup', () => {
        clearTimeout(clickTimer); 
    });
    function ClickMovement(event){
        let rect = e.world.getBoundingClientRect();
        let xInWorld = (event.clientX - rect.left) / zoom;
        let yInWorld = (event.clientY - rect.top) / zoom;

        let xInVW = (xInWorld / window.innerWidth) * 100;
        let yInVH = (yInWorld / window.innerHeight) * 100;
        xInVW += state.posX;
        yInVH += state.posY;

        xInVW = xInVW.toFixed(2);
        yInVH = yInVH.toFixed(2);
        xInVW -= 50;
        yInVH -= 50;
        returnToObjectPreside(xInVW, yInVH);
    }
}

pointClickMovement();

function returnToObjectPreside(xInVW, yInVH){
    let maxTime = 270;
    let maxDistance = 9;
    let msForVw = maxTime / maxDistance;
    xInVW -= state.posX;
    yInVH -= state.posY;
    let stepX = xInVW / maxDistance;
    stepX = Math.trunc(stepX);
    let differenceX = xInVW - (stepX * maxDistance);
    
    let stepY = yInVH / maxDistance;
    stepY = Math.trunc(stepY);
    let differenceY = yInVH - (stepY * maxDistance);

    let time = 0;
    selectKeysX(stepX, time, maxTime);
    selectKeysY(stepY, time, maxTime);
    setTimeout(() => {
        time = 0;
    maxTime2 = Math.abs(differenceX) * msForVw;
    maxTime3 = Math.abs(differenceY) * msForVw;
    if(differenceX > 0) selectKeysX(1, time, maxTime2);
    else if(differenceX < 0) selectKeysX(-1, time, maxTime2)
    time = 0;
    if(differenceY > 0) selectKeysY(1, time, maxTime3);
    else if(differenceY) selectKeysY(-1, time, maxTime3);
    }, (Math.abs(stepX) * (maxTime + 50))+(Math.abs(stepY) * (maxTime + 50)));
    
}

function selectKeysX(stepX, time, maxTime){
    time = 0;
    if(stepX > 0){
        for(i=0;i<stepX;i++){
                setTimeout(() => {
                    simulateKey('KeyD', maxTime);
                }, time);
                time += maxTime + 300;
        }
    } else if(stepX < 0){
        for(i=0;i>stepX;i--){
                setTimeout(() => {
                    simulateKey('KeyA', maxTime);
                }, time);
                time += maxTime + 300;
        }
    }
}

function selectKeysY(stepY, time, maxTime){
    time = 0;
    if(stepY > 0){
        for(i=0;i<stepY;i++){
                setTimeout(() => {
                    simulateKey('KeyS', maxTime);
                }, time);
                time += maxTime + 300;
        }
    } else if(stepY < 0){
        for(i=0;i>stepY;i--){
                setTimeout(() => {
                    simulateKey('KeyW', maxTime);
                }, time);
                time += maxTime + 300;
        }
    }
}

function simulateKey(code, duration){
    keys[code] = true;
    handleKeydown({ code }); 

    setTimeout(() => {
        keys[code] = false;
        handleKeyup({ code }); 
    }, duration);
}


function handleKeydown(event) {
if(!state.cond_deactivate_movement){
    e.imgsArray = Array.from(document.querySelectorAll('.school_imgs'));
    keys[event.code] = true;
    if (["KeyW", "KeyA", "KeyS", "KeyD"].includes(event.code)) {
        currentDir = getDirection();
        if (currentDir.x === 0 && currentDir.y === 0) return;
            if(!isCharging && !event.repeat){
                isCharging = true;
                jumpStartTime = performance.now();
                
            }
        }
    }
}

function handleKeyup(event){
    if(!state.cond_deactivate_movement){
        keys[event.code] = false;
        if(["KeyW", "KeyA", "KeyS", "KeyD"].includes(event.code)){
            if(isCharging){
                isCharging = false;
                let heldFor = performance.now() - jumpStartTime;
                if(heldFor > 270){
                    heldFor = 270;
                } 
                let distance = heldFor / 30;
                jumpDirection(distance, currentDir);
            }
        }
    }
}
function getDirection(){
    let dir = { x: 0, y: 0 };
    if (keys["KeyW"]) dir.y -= 1;
    if (keys["KeyS"]) dir.y += 1;
    if (keys["KeyA"]) dir.x -= 1;
    if (keys["KeyD"]) dir.x += 1;

    const magnitude = Math.hypot(dir.x, dir.y);
    if (magnitude > 0) {
        dir.x /= magnitude;
        dir.y /= magnitude;
    } else {
        dir.x = 0;
        dir.y = 0;
    }
    
    return dir;
}

function jumpDirection(distance, dir){
    dir.x = parseFloat((dir.x).toFixed(1));
    dir.y = parseFloat((dir.y).toFixed(1));
    if(dir.x == -1 && dir.y == 0) left(distance);
    else if(dir.x == 1 && dir.y == 0) right(distance);
    if(dir.y == 1 && dir.x == 0) down(distance);
    else if(dir.y == -1 && dir.x == 0) top(distance);
    else if (dir.x == 0.7 && dir.y == -0.7) diagonalTopRight(distance);
    else if (dir.x == -0.7 && dir.y == -0.7) diagonalTopLeft(distance);
    else if (dir.x == 0.7 && dir.y == 0.7) diagonalLowRight(distance);
    else if (dir.x == -0.7 && dir.y == 0.7) diagonalBottomLeft(distance);
    control_position(state, e);
}

function left(distance){
    
    state.posX -= distance;
    e.imgsArray.forEach(img => {
        img.style.left = (parseFloat(img.style.left) + distance) + 'vw';
    });
    for(let i=0;i<importantObjects.length;i++){
        for(let j=0;j<importantObjects[i].length-1;j+=2){
            importantObjects[i][j] = (parseFloat(importantObjects[i][j]) + distance) + 'vw';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][0] = (parseFloat(matTert[i][0]) + distance) + 'vw';
    }
    animationJumpLeft(distance);
}

async function animationJumpLeft(distance){
    
    p.style.transform = "scaleX(-1)";
    p.src = "Preside.png";
    const step = [60, 120, 180, 240, 300];
    const delta = [distance/2*-1, distance/2*-1, 0, distance/2, distance/2];
        step.forEach((ms, i) => {
            setTimeout(() => {
                p.style.top = (parseFloat(p.style.top) + delta[i]) + 'vh';
            }, ms);
        });
}

function right(distance){
    
    state.posX += distance;
    e.imgsArray.forEach(img => {
        img.style.left = (parseFloat(img.style.left) - distance) + 'vw';
    });
    for(let i=0;i<importantObjects.length;i++){
        for(let j=0;j<importantObjects[i].length-1;j+=2){
            importantObjects[i][j] = (parseFloat(importantObjects[i][j]) - distance) + 'vw';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][0] = (parseFloat(matTert[i][0]) - distance) + 'vw';
    }
    animationJumpRight(distance);
}

async function animationJumpRight(distance){
    p.style.transform = "scaleX(1)";
    p.src = "Preside.png";
    const step = [60, 120, 180, 240, 300];
    const delta = [distance/2*-1, distance/2*-1, 0, distance/2, distance/2];
        step.forEach((ms, i) => {
            setTimeout(() => {
                p.style.top = (parseFloat(p.style.top) + delta[i]) + 'vh';
            }, ms);
        });
}

function down(distance){
    state.posY += distance;
    e.imgsArray.forEach(img => {
        img.style.top = (parseFloat(img.style.top) - distance) + 'vh';
    });
    for(let i=0;i<importantObjects.length;i++){
        for(let j=0;j<importantObjects[i].length-1;j+=2){
            importantObjects[i][j+1] = (parseFloat(importantObjects[i][j+1]) - distance) + 'vh';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][1] = (parseFloat(matTert[i][1]) - distance) + 'vh';
    }
    animationJumpDown(distance);
}

async function animationJumpDown(distance){
    p.src = "Preside_davanti.png";
    const step = [60, 120, 180, 240, 300];
    const delta = [distance/2, distance/2, 0, distance/2*-1, distance/2*-1];
        step.forEach((ms, i) => {
            setTimeout(() => {
                p.style.top = (parseFloat(p.style.top) + delta[i]) + 'vh';
            }, ms);
        });
}

function top(distance){
    state.posY -= distance;
    e.imgsArray.forEach(img => {
        img.style.top = (parseFloat(img.style.top) + distance) + 'vh';
    });
    for(let i=0;i<importantObjects.length;i++){
        for(let j=0;j<importantObjects[i].length-1;j+=2){
            importantObjects[i][j+1] = (parseFloat(importantObjects[i][j+1]) + distance) + 'vh';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][1] = (parseFloat(matTert[i][1]) + distance) + 'vh';
    }
    animationJumpTop(distance);
}

async function animationJumpTop(distance){
    p.src = "Preside_dietro.png";
    const step = [60, 120, 180, 240, 300];
    const delta = [distance/2*-1, distance/2*-1, 0, distance/2, distance/2];
        step.forEach((ms, i) => {
            setTimeout(() => {
                p.style.top = (parseFloat(p.style.top) + delta[i]) + 'vh';
            }, ms);
        });
}

function diagonalTopRight(distance) {
    state.posX += distance;
    state.posY -= distance;
    e.imgsArray.forEach(img => {
        img.style.left = (parseFloat(img.style.left) - distance) + 'vw';
        img.style.top = (parseFloat(img.style.top) + distance) + 'vh';
    });
    for (let i = 0; i < importantObjects.length; i++) {
        for (let j = 0; j < importantObjects[i].length - 1; j += 2) {
            importantObjects[i][j] = (parseFloat(importantObjects[i][j]) - distance) + 'vw';
            importantObjects[i][j + 1] = (parseFloat(importantObjects[i][j + 1]) + distance) + 'vh';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][0] = (parseFloat(matTert[i][0]) - distance) + 'vw';
        matTert[i][1] = (parseFloat(matTert[i][1]) + distance) + 'vh';
    }
    animationJumpDiagonal(distance);
}

function diagonalTopLeft(distance) {
    
    state.posX -= distance;
    state.posY -= distance;
    e.imgsArray.forEach(img => {
        img.style.left = (parseFloat(img.style.left) + distance) + 'vw';
        img.style.top = (parseFloat(img.style.top) + distance) + 'vh';
    });
    for (let i = 0; i < importantObjects.length; i++) {
        for (let j = 0; j < importantObjects[i].length - 1; j += 2) {
            importantObjects[i][j] = (parseFloat(importantObjects[i][j]) + distance) + 'vw';
            importantObjects[i][j + 1] = (parseFloat(importantObjects[i][j + 1]) + distance) + 'vh';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][0] = (parseFloat(matTert[i][0]) + distance) + 'vw';
        matTert[i][1] = (parseFloat(matTert[i][1]) + distance) + 'vh';
    }
    animationJumpDiagonal(distance);
}

function diagonalLowRight(distance) {
    
    state.posX += distance;
    state.posY += distance;
    e.imgsArray.forEach(img => {
        img.style.left = (parseFloat(img.style.left) - distance) + 'vw';
        img.style.top = (parseFloat(img.style.top) - distance) + 'vh';
    });
    for (let i = 0; i < importantObjects.length; i++) {
        for (let j = 0; j < importantObjects[i].length - 1; j += 2) {
            importantObjects[i][j] = (parseFloat(importantObjects[i][j]) - distance) + 'vw';
            importantObjects[i][j + 1] = (parseFloat(importantObjects[i][j + 1]) - distance) + 'vh';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][0] = (parseFloat(matTert[i][0]) - distance) + 'vw';
        matTert[i][1] = (parseFloat(matTert[i][1]) - distance) + 'vh';
    }
    animationJumpDiagonal(distance);
}

function diagonalBottomLeft(distance) {
    
    state.posX -= distance;
    state.posY += distance;
    e.imgsArray.forEach(img => {
        img.style.left = (parseFloat(img.style.left) + distance) + 'vw';
        img.style.top = (parseFloat(img.style.top) - distance) + 'vh';
    });
    for (let i = 0; i < importantObjects.length; i++) {
        for (let j = 0; j < importantObjects[i].length - 1; j += 2) {
            importantObjects[i][j] = (parseFloat(importantObjects[i][j]) + distance) + 'vw';
            importantObjects[i][j + 1] = (parseFloat(importantObjects[i][j + 1]) - distance) + 'vh';
        }
    }
    for(i=0;i<matTert.length;i++){
        matTert[i][0] = (parseFloat(matTert[i][0]) + distance) + 'vw';
        matTert[i][1] = (parseFloat(matTert[i][1]) - distance) + 'vh';
    }
    animationJumpDiagonal(distance);
}

async function animationJumpDiagonal(distance) {
    p.src = "Preside_dietro.png"; 
    const step = [60, 120, 180, 240, 300];
    const delta = [distance/2*-1, distance/2*-1, 0, distance/2, distance/2];
    step.forEach((ms, i) => {
        setTimeout(() => {
            p.style.top = (parseFloat(p.style.top) + delta[i]) + 'vh';
        }, ms);
    });
}


window.addEventListener('keydown', handleKeydown);
window.addEventListener('keyup', handleKeyup);

    
    
  }
  
  function control_position(state, e) {
    state.posX = Math.round(state.posX);
    state.posY = Math.round(state.posY);
    if((state.posX >= 44 && state.posX <= 50) && (state.posY >= 66 && state.posY <= 79)){
        document.getElementById('key_e'+0).style.opacity = '1';
        window.addEventListener('keydown', function(event) {
            if (event.key === 'e' || event.key === 'E') {
                if(matTert[4][4] == false) interaction(0, e, state);
            }
        });
    }
    else{
        document.getElementById('key_e'+0).style.opacity = '0';
        if((state.posX >= 107 && state.posX <= 110) && (state.posY >=-60 && state.posY <= -51)){
            document.getElementById('key_e'+1).style.opacity = '1';
            window.addEventListener('keydown', function(event) {
                if (event.key === 'e' || event.key === 'E') {
                    interaction(1, e, state);
                }
            });
        }
    }
}

function openConstructionMenu(e, state){
        state.cond_deactivate_movement = true;
        clearInterval(intervalMovement);
        e.costruction_menu.style.opacity = '1';
        document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
                state.cond_deactivate_movement = false;
                closeCostructionMenu(e, state);
            }
        });
}

function closeCostructionMenu(e, state){
    e.costruction_menu.style.opacity = '0';
}


function setupMenuToggle(e) {
  e.toggle_icon.addEventListener('mouseenter', () => e.toggle_icon.style.opacity = '0.7');
  e.toggle_icon.addEventListener('mouseleave', () => e.toggle_icon.style.opacity = '1');
  e.toggle_icon.addEventListener('click', () => {
    e.menu.classList.toggle('open');
    e.menu.classList.toggle('closed');
  });
}
function interaction(index, e, state){
    switch(index){
        case 0:
            matTert[index][4] = true;
            e.preside.style.transform = 'scaleX(1)';
            const character = document.getElementById('character4');
            character.style.transform = 'scaleX(1)';
            document.getElementById('key_e' + index).style.display = 'none';        
            jolt(character, e, state);
            break;
        case 1:
            state.cond_table = true;
            openConstructionMenu(e, state);
    }
}



let N = 10;
function creationTertiaryCharacters(e, state) {
    let i;
    let scaleX;
    
    for(i=0;i<N;i++){
        createCharacter(e, state, i);
    }
}
function createCharacter(e, state, i) {
    const character_container = document.createElement('div');
    character_container.style.left = matTert[i][0];
    character_container.style.top = matTert[i][1];
    character_container.style.zIndex = matTert[i][4];
    character_container.id = 'character' + i;
    character_container.className = 'school_imgs';
    character_container.style.position = 'fixed';
    character_container.style.transition = 'left 0.3s ease-in-out, top 0.25s ease-in-out';
    const character_img = document.createElement('img');
    character_img.src = matTert[i][5];
    character_img.style.width = '28vw';
    character_img.id = 'characterImg' + i;
    if(matTert[i][5] == 'bob.png') character_img.style.height = '27vh';
    else character_img.style.height = '20vh';

    if(matTert[i][3] == 1) {
        character_container.style.transform = 'scaleX(1)';
    } else if (matTert[i][3] == -1) {
        character_container.style.transform = 'scaleX(-1)';
    } 

    character_container.appendChild(character_img);
    e.world.appendChild(character_container);
    e.world.appendChild(document.getElementById("character"+i))
    switch (matTert[i][2]){
        case 'group':
            passiveAnimationGroup(character_container, i, e, state);
            break;
        case 'work-alone':
             passiveAnimationWorkAlone(character_container, i, e);
            setInterval(() => {
                passiveAnimationWorkAlone(character_container, i, e);
            }, 8000);
            break;
        case 'alone':
            let posX = parseFloat(matTert[i][0]) + 13;
            let posY = parseFloat(matTert[i][1]) - 10;
            const illustration = createIllustration('vignetta_musica.png', posX, posY, e);
        animateIllustration(illustration, i);
        setInterval(() => {
            passiveAnimationAlone(character_container, i, e, illustration);
            }, 1000);
            break;
        case 'walk-casually':
            let posX2 = parseFloat(matTert[i][0]) + 13;
            let posY2 = parseFloat(matTert[i][1]) - 10;
            const illustration2 = createIllustration('vignetta_fischietto.png', posX2, posY2, e);
            animateIllustration(illustration2, i);
            passiveAnimationWalking(character_container, i, e, illustration2, state);
           
            break;
    }
}
function animateIllustration(illustration, i){
    let interval = setInterval(() => {
            if(matTert[i][4] == false){
                let illustration_time = Math.floor(Math.random() * (5000 - 1000 + 1)) + 1000;
                setTimeout(() => {
                                illustration.style.opacity = '1';
                            setTimeout(() => {
                                illustration.style.opacity = '0';
                            }, 2000);
                }, illustration_time);
            }
            else{
                clearInterval(interval);
            }
        }, 5000);
}
let i_illustration = 0;
function createIllustration(sr, posX, posY, e){
        const illustration = document.createElement('img');
        illustration.src = sr;
        illustration.style.opacity = '0';
        illustration.style.transition = 'opacity 0.1s ease-out, left 0.3s ease-in-out, top 0.35s ease-in-out';
        illustration.style.width = '10vw';
        illustration.style.height = '15vh';
        illustration.style.left = `${posX}vw`;
        illustration.style.top = `${posY}vh`;
        illustration.className = 'school_imgs';
        illustration.id = 'illustration'+i_illustration;
        i_illustration++;
        e.world.appendChild(illustration);
        return illustration;
}

let interval = [];
function passiveAnimationGroup(character, i, e, state, posX = 0, posY = 0) {
    state.maxTimeAnimationGroup[i] = 4000;
    character.style.transition = "left 0.3s ease-in-out, top 0.25s ease-in-out";
    if(posX == 0){
        if(matTert[i][5] == 'bob.png'){
            posX = parseFloat(matTert[i][0]) + 13;
            posY = parseFloat(matTert[i][1]) - 2;
        }
        else{
            posX = parseFloat(matTert[i][0]) + 13;
            posY = parseFloat(matTert[i][1]) - 5;
        }
    }
    const illustration = createIllustration('vignetta_dialogo.png', posX, posY, e);
    let time = Math.floor(Math.random() * (state.maxTimeAnimationGroup[i] - 1000 + 1)) + 1000;
    let illustration_time = Math.floor(Math.random() * (5000 - 1000 + 1)) + 1000;
    setTimeout(() => {
                    illustration.style.opacity = '1';
                setTimeout(() => {
                        illustration.style.opacity = '0';
                }, 3000);
    }, illustration_time);
            setTimeout(() => {
                posY = parseFloat(character.style.top);
                posY = parseFloat(posY) - 3;
                    character.style.top = `${posY}vh`;
                    setTimeout(() => {
                        posY = parseFloat(character.style.top) + 3;
                        character.style.top = `${posY}vh`;
                    }, 300);
            }, time);
    
    interval[i] = setInterval(() => {
            let time = Math.floor(Math.random() * (state.maxTimeAnimationGroup[i] - 1000 + 1)) + 1000;
            if(state.condBP1 == true) {
                clearInterval(interval[5]);
                clearInterval(interval[6]);
                state.condBP1 = false;
            }
            setTimeout(() => {
                    posY = parseFloat(character.style.top);
                    posY = parseFloat(posY) - 3;
                    character.style.top = `${posY}vh`;
                    setTimeout(() => {
                        posY = parseFloat(character.style.top) + 3;
                        character.style.top = `${posY}vh`;
                    }, 300);
            }, time);
            let illustration_time = Math.floor(Math.random() * (5000 - 1000 + 1)) + 1000;
            setTimeout(() => {
                            illustration.style.opacity = '1';
                        setTimeout(() => {
                                illustration.style.opacity = '0';
                        }, 3000);
            }, illustration_time);
    }, 5000);
}
async function passiveAnimationWorkAlone(character, i, e, state){
    character.style.transition = "left 0.3s ease-in-out, top 0.35s ease-in-out";
    const sleep =  ms => new Promise(r => setTimeout(r, ms));
    
    const step = async (action, delay, scaleX) => {
        await sleep(delay);
        if(scaleX) {
            character.style.transform = 'scaleX(1)';
        } else {
            character.style.transform = 'scaleX(-1)';
        }
        if (typeof window[action] === 'function') {
            window[action](character, false);
        }
    };
    /*
    await step("rightJump", Math.floor(Math.random() * (state.maxTimeAnimationWorkAlone - 500 + 1)) + 500, true);
    await step("rightJump", Math.floor(Math.random() * (state.maxTimeAnimationWorkAlone - 500 + 1)) + 500, true);
    await step("leftJump", Math.floor(Math.random() * (state.maxTimeAnimationWorkAlone - 500 + 1)) + 500, false);
    await step("leftJump", Math.floor(Math.random() * (state.maxTimeAnimationWorkAlone - 500 + 1)) + 500, false);
    */
}

async function passiveAnimationAlone(character, i, e, illustration, state){
    character.style.transition = "left 0.3s ease-in-out, top 0.35s ease-in-out";
    illustration.style.transition = "left 0.3s ease-in-out, top 0.35s ease-in-out";
    let illustration_time = Math.floor(Math.random() * (5000 - 1000 + 1)) + 1000;
    const sleep =  ms => new Promise(r => setTimeout(r, ms));
    const step = async (delay) => {
        if(matTert[i][4] == true){
            illustration.style.opacity = '0';
            illustration.style.display = 'none';
            document.getElementById('key_e'+4).style.display = 'none';
            return;
        }
        else{
            let dec = (Math.floor(Math.random() * 1) + 2);
            character.style.top = parseFloat(character.style.top) - dec + 'vh';
            illustration.style.top = parseFloat(illustration.style.top) - dec + 'vh';
            setTimeout(() => {
                character.style.top = parseFloat(character.style.top) + dec + 'vh';
                illustration.style.top = parseFloat(illustration.style.top) + dec + 'vh';
            }, 350);
            await sleep(delay);
        }
        
    };
    /*
    step(Math.floor(Math.random() * (state.maxTimeAnimationAlone - 200 + 1)) + 400);
    step(Math.floor(Math.random() * (state.maxTimeAnimationAlone - 200 + 1)) + 400);
    step(Math.floor(Math.random() * (state.maxTimeAnimationAlone - 200 + 1)) + 400);
    */
}

let sommaX = 0;
let sommaY = 0;
function passiveAnimationWalking(character, i, e, illustration, state){
    let stepX = Math.floor(Math.random() * (5 - (-5) + 1)) + (-5);
    sommaX+=(stepX*9);
    while(sommaX < -50 || sommaX > 150){
        sommaX -= (stepX*9);
        stepX = Math.floor(Math.random() * (5 - (-5) + 1)) + (-5);
        sommaX+=(stepX*9);
    }
    let stepY = Math.floor(Math.random() * (5 - (-5) + 1)) + (-5);    
    sommaY+=(stepY*9);
    while(sommaY < -150 || sommaY > 50){
        sommaY -= (stepY*9);
        stepY = Math.floor(Math.random() * (5 - (-5) + 1)) + (-5);
        sommaY+=(stepY*9);
    }
    
    returnToObject(character, false, false, false, state, e, stepX, stepY, illustration);
    setTimeout(() => {
        passiveAnimationWalking(character, i, e, illustration, state);
    }, Math.abs(stepX) * 750 + Math.abs(stepY) * 750); 
}

async function jolt(character, e, state) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    character.style.transition = "top 0.2s ease-out, left 0.2s ease-out";
    const step = async (topDelta, leftDelta, delay) => {
        if(topDelta == true) matTert[4][4] = true;
        else{
        await sleep(delay);
        character.style.top = (parseFloat(character.style.top) + topDelta) + 'vh';
        character.style.left = (parseFloat(character.style.left) + leftDelta) + 'vw';
        }
    };

    await step('true', 0, 0)
    await step(-3, 2, 0);
    await step(-2, 2, 90);
    await step(-2, 2, 90);
    await step(-1.5, 2, 90);
    await step(1.5, 2, 90);
    await step(2, 2, 90);
    await step(2, 2, 90);
    await step(3, 1, 90);
    await sleep(1500);
    await returnToObject(character, importantObjects[0][2], importantObjects[0][3], true, state);
}

async function returnToObject(character, x, y, order = false, state, e = initialiseElements(), stepx, stepy, illustration){
    let halfStepX = false;
    let halfStepY = false;
    let aQuarterStepX = false;
    let aQuarterStepY = false;
    if(x != false){
        let stepX = (parseFloat(x) - parseFloat(character.style.left)) / 8;
        let stepY = (parseFloat(y) - parseFloat(character.style.top)) / 5;
        let diffStepX = Math.abs(stepX - Math.trunc(stepX));
        stepX -= diffStepX;

        if (diffStepX > 0.5) {
            halfStepX = true;
        }
        diffStepX = Math.abs(stepX - Math.trunc(stepX));
        if(diffStepX > 0.25){
            halfStepX = false;
            aQuarterStepX = true;
        }
        let diffStepY = Math.abs(stepY - Math.trunc(stepY));
        stepY -= diffStepY;
        if (diffStepY > 0.5) {
            halfStepY = true;
        }
        diffStepY = Math.abs(stepY - Math.trunc(stepY));
        if(diffStepY > 0.25){
            halfStepX = false;
            aQuarterStepY = true;
        }

        stepX = Math.trunc(stepX);
        stepY = Math.trunc(stepY);
        move(character, order, stepX, stepY);
    }
    else{
        let stepX = stepx;
        let stepY = stepy;
        move(character, order, stepX, stepY, x);
    }
    async function move(character, order, stepX, stepY, cond = true){
        const sleep =  ms => new Promise(r => setTimeout(r, ms));
        const step = async (action, delay, parameter = false, parameter2 = false) => {
            if (typeof window[action] === 'function') {
                window[action](character, parameter);
                if(!cond){
                    window[action](illustration, parameter);
                    typeAnimation = controlClose(character, state);
                    if(typeAnimation != null){
                        fastAnimations(state.ids, state);
                } 
        }
            }
            await sleep(delay);
        };
        if (!order) {
        if(stepX < 0) {
            for(let i = 0; i > stepX; i--) {
                await step("leftJump", 500);
            }
            if(halfStepX){
                parameter = true;
                await step("leftJump", 500, parameter);
            }
            if(aQuarterStepX){
                parameter2 = true;
                await step("leftJump", 500, false, parameter2);
            }
        } else {
            for(let i = 0; i < stepX; i++) {
                await step("rightJump", 500);
            }
            if(halfStepX){
                parameter = true;
                await step("rightJump", 500, parameter);
            }
            if(aQuarterStepX){
                parameter2 = true;
                await step("rightJump", 500, false, parameter2);
            }
        }

        if(stepY < 0) {
            for(let i = 0; i > stepY; i--) {
                await step("topJump", 500);
            }
            if(halfStepY){
                parameter = true;
                await step("topJump", 500, parameter);
            }
            if(aQuarterStepY){
                parameter2 = true;
                await step("topJump", 500, false, parameter2);
            }
        } else {
            for(let i = 0; i < stepY; i++) {
                await step("downJump", 500);
            }
            if(halfStepY){
                parameter = true;
                await step("downJump", 500, parameter);
            }
            if(aQuarterStepY){
                parameter2 = true;
                await step("downJump", 500, false, parameter2);
            }
        }

    } else {
        if(stepY < 0) {
            for(let i = 0; i > stepY; i--) {
                await step("topJump", 500);
            }
            if(halfStepY){
                parameter = true;
                await step("topJump", 500, parameter);
            }
            if(aQuarterStepY){
                parameter2 = true;
                await step("topJump", 500, false, parameter2);
            }
        } else {
            for(let i = 0; i < stepY; i++) {
                await step("downJump", 500);
            }
            if(halfStepY){
                parameter = true;
                await step("downJump", 500, parameter);
            }
            if(aQuarterStepY){
                parameter2 = true;
                await step("downJump", 500, false, parameter2);
            }
        }

        if(stepX < 0) {
            for(let i = 0; i > stepX; i--) {
                await step("leftJump", 500);
            }
            if(halfStepX){
                parameter = true;
                await step("leftJump", 500, parameter);
            }
            if(aQuarterStepX){
                parameter2 = true;
                await step("leftJump", 500, false, parameter2);
            }
        } else {
            for(let i = 0; i < stepX; i++) {
                await step("rightJump", 500);
            }
            if(halfStepX){
                parameter = true;
                await step("rightJump", 500, parameter);
            }
            if(aQuarterStepX){
                parameter2 = true;
                await step("rightJump", 500, false, parameter2);
            }
        }
}
    if(!cond){
        return;
    }
    else{
        await passiveAnimationGroup(character, 6, e, state, parseFloat(character.style.left) + 12, parseFloat(character.style.top) - 8);
    }
    }
}

function controlClose(character, state){
    let cont = 0;
    for(i=0;i<N;i++){
        if(Math.abs(parseFloat(character.style.left) - parseFloat(matTert[i][0])) <= 50 && Math.abs(parseFloat(character.style.top) - parseFloat(matTert[i][1]) <= 50)){
            state.ids[cont] = i;
            cont++;
        }
    }
    if(cont == 0) return null;
    else return 0;
}
let cond_ripeti_controllo = true;
function fastAnimations(ids, state){
    let i;
    if(cond_ripeti_controllo){
        for(i=0;i<ids.length-1;i++){
            if(matTert[ids[i]][2] == 'group'){
                cond_ripeti_controllo = false;
                state.maxTimeAnimationGroup[ids[i]] /= 10;
            } 
            
        }
        
        for (let j = 0; j < ids.length - 1; j++) {
            if (matTert[ids[j]][2] == 'group') {
                setTimeout(() => {
                    state.maxTimeAnimationGroup[ids[j]] *= 10;
                    cond_ripeti_controllo = true;
                }, 2000);
            }
        }
    }
    
}
    
function centralizationPreside(e, state) {
    const p = e.preside_container;
    p.style.top = "50%";
    p.style.left = "30%";
    doubleJump(p);
}
async function doubleJump(p) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    await sleep(2000); 
    await rightJumpP(p);
    await sleep(500); 
    await rightJumpP(p); 
}

async function rightJumpP(character) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    character.style.transition = "top 0.1s ease-out, left 0.1s ease-out";

    const step = async (topDelta, leftDelta, delay) => {
        await sleep(delay);
        character.style.top = (parseFloat(character.style.top) + topDelta) + '%';
        character.style.left = (parseFloat(character.style.left) + leftDelta) + '%';
    };


    await step(-2, 1, 0);
    await step(-2, 2, 100);
    await step(-0.5, 2, 100);
    await step(0.5, 2, 100);
    await step(2, 2, 100);
    await step(2, 1, 100);
}

async function rightJump(character, half, a_quarter) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    character.style.transition = "top 0.06s ease-out, left 0.06s ease-out";

    const step = async (topDelta, leftDelta, delay) => {
        await sleep(delay);
        character.style.top = (parseFloat(character.style.top) + topDelta) + 'vh';
        character.style.left = (parseFloat(character.style.left) + leftDelta) + 'vw';
        
    };
    if (a_quarter) {
        await step(-0.375, 0.375, 0);
        await step(-0.375, 0.375, 60);
        await step(-0.25, 0.5, 60);
        await step(0.25, 0.5, 60);
        await step(0.375, 0.375, 60);
        await step(0.375, 0.375, 60);
        await ripristineTransition(character);
    }
    if(half){
        await step(-0.75, 0.75, 0);
        await step(-0.75, 0.75, 60);
        await step(-0.5, 1, 60);
        await step(0.5, 1, 60);
        await step(0.75, 0.75, 60);
        await step(0.75, 0.75, 60);
        await ripristineTransition(character);
    }
    else{
        await step(-1.5, 1.5, 0);
        await step(-1.5, 1.5, 60);
        await step(-0.5, 1, 60);
        await step(0.5, 1, 60);
        await step(1.5, 1.5, 60);
        await step(1.5, 1.5, 60);
        await ripristineTransition(character);
    }
    
}

async function topJump(character, half, a_quarter) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    character.style.transition = "top 0.06s ease-out, left 0.06s ease-out";

    const step = async (topDelta, delay) => {
        await sleep(delay);
        character.style.top = (parseFloat(character.style.top) + topDelta) + 'vh';
        character.style.transition = "top 0.25s ease-out, left 0.25s ease-out";
    };
    if (a_quarter) {
        await step(-0.375, 0);
        await step(-0.375, 60);
        await step(-0.25, 60);
        await step(0.25, 60);
        await ripristineTransition(character);
    }
    if(half){
        await step(-0.75, 0);
        await step(-0.75, 60);
        await step(-0.5, 60);
        await step(0.5, 60);
        await ripristineTransition(character);
    }
    else{
        await step(-2.5, 0);
        await step(-2.5, 60);
        await step(-1.5, 60);
        await step(1.5, 60);
        await ripristineTransition(character);
    }
}
async function leftJump(character, half, a_quarter) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    character.style.transition = "top 0.06s ease-out, left 0.06s ease-out";

    const step = async (topDelta, leftDelta, delay) => {
        await sleep(delay);
        character.style.top = (parseFloat(character.style.top) + topDelta) + 'vh';
        character.style.left = (parseFloat(character.style.left) + leftDelta) + 'vw';
        character.style.transition = "top 0.25s ease-out, left 0.25s ease-out";
    };
    if (a_quarter) {
        await step(-0.375, -0.375, 0);
        await step(-0.375, -0.375, 60);
        await step(-0.25, -0.5, 60);
        await step(0.25, -0.5, 60);
        await step(0.375, -0.375, 60);
        await step(0.375, -0.375, 60);
        await ripristineTransition(character);
    }
    if(half){
        await step(-0.75, -0.75, 0);
        await step(-0.75, -0.75, 60);
        await step(-0.5, -1, 60);
        await step(0.5, -1, 60);
        await step(0.75, -0.75, 60);
        await step(0.75, -0.75, 60);
        await ripristineTransition(character);
    }
    else{
        await step(-1.5, -1.5, 0);
        await step(-1.5, -1.5, 60);
        await step(-0.5, -1, 60);
        await step(0.5, -1, 60);
        await step(1.5, -1.5, 60);
        await step(1.5, -1.5, 60);
        await ripristineTransition(character);
    }
}

async function downJump(character, half, a_quarter) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    character.style.transition = "top 0.06s ease-out, left 0.06s ease-out";

    const step = async (topDelta, delay) => {
        await sleep(delay);
        character.style.top = (parseFloat(character.style.top) + topDelta) + 'vh';
    };
    if (a_quarter) {
        await step(0.375, 0);
        await step(0.375, 60);
        await step(0.25, 60);
        await step(-0.25, 60);
        await ripristineTransition(character);
    }
    if(half){
        await step(0.75, 0);
        await step(0.75, 60);
        await step(0.5, 60);
        await step(-0.5, 60);
        await ripristineTransition(character);
    }
    else{
        await step(2.5, 0);
        await step(2.5, 60);
        await step(1.5, 60);
        await step(-1.5, 60);
        await ripristineTransition(character);
    }
}
function ripristineTransition(character){
    character.style.transition = "top 0.25s ease-out, left 0.25s ease-out";
}

function diaologueB_P1(e, state) {
    setTimeout(() => {
        state.cond_movement = true;
        const t = document.getElementById('character6');
        const t_illustration = document.getElementById('illustration5');
        const bob_illustration = document.getElementById('illustration4');
        t.style.left = '80vw';
        t.style.top = '39vh';
        t.style.transform = "scaleX(-1)";
        bob_illustration.style.opacity = '0';
        t_illustration.style.opacity = '0';
        state.condBP1 = true;
        removeIllustration(bob_illustration, t_illustration);

        async function exit(t) {
            const sleep = ms => new Promise(r => setTimeout(r, ms));
            await rightJump(t, false);
            await sleep(200); 
            await rightJump(t, false); 
            await sleep(500);
            await moveBob(t);
            await returnToObject(t, importantObjects[0][0], importantObjects[0][1], false, state); 
        }
        
        function moveBob(t) {
            const bob = document.getElementById('character5');
            bob.style.transform = "scaleX(-1)";
            clearInterval(interval[5]);
            bob_illustration.style.opacity = '1';
            bob_illustration.src = 'vignetta_esclamazione.png';
            async function jumpBob(b, t) {
                const sleep = ms => new Promise(r => setTimeout(r, ms));
                await sleep(700);
                await removeIllustration(bob_illustration, t_illustration)
                await sleep(300);
                await leftJump(b);
                await sleep(400); 
                await leftJump(b); 
                await sleep(300);
                await leftJump(b, true);
                await sleep(500);
                await dialogue(b, t);
            }
            jumpBob(bob, t);
        }
        function removeIllustration(b, t) {
            return new Promise(resolve => {
                b.style.opacity = '0';
                t.style.opacity = '0';
                setTimeout(() => {
                    resolve();
                }, 200);
            });
        }
        function dialogue(b, t){
            b.style.transition = "left 0.3s ease-in-out, top 0.3s ease-in-out";
            t.style.transition = "left 0.3s ease-in-out, top 0.3s ease-in-out";
            e.container_dialogue.style.opacity = '1';
            state.cond_skip = true;
            state.cond_dialogue = true;
            showNextLine();
        }
        exit(t);

    }, 5000);
}

function activateCinematicMode() {
  document.getElementById('cinematic-bars').classList.add('cinematic');
}

function deactivateCinematicMode() {
  document.getElementById('cinematic-bars').classList.remove('cinematic');
}

function mobileAdaptation(e, state){
    document.body.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, { passive: false });

    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });
}

</script>
